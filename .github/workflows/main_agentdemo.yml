# ============================================
# DAFC OTB Platform - Azure App Service Deployment
# ============================================
# 
# Deploy Next.js app (standalone mode) to Azure App Service.
# 
# Architecture:
#   - Next.js app with standalone output for minimal deployment
#   - API routes at /api/v1/* connect directly to PostgreSQL via Prisma
#
# Required GitHub Secrets:
#   - AZURE_WEBAPP_PUBLISH_PROFILE: Publish profile from Azure App Service
#   - DATABASE_URL: PostgreSQL connection string (Supabase/Azure)
#   - AUTH_SECRET: NextAuth secret key  
#   - OPENAI_API_KEY: OpenAI API key (optional, for AI features)
#
# Azure App Service Configuration:
#   - Runtime: Node 20 LTS
#   - Startup Command: node server.js
# ============================================

name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9.15.0'
  AZURE_WEBAPP_NAME: agentdemo

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter=@dafc/database db:generate

      - name: Build Next.js app
        run: pnpm --filter=@dafc/web build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Prepare deployment package
        run: |
          set -e
          mkdir -p deploy
          
          echo "=========================================="
          echo "Step 1: Analyzing standalone output"
          echo "=========================================="
          
          cd apps/web
          echo "Contents of .next/standalone/:"
          ls -la .next/standalone/
          
          # Check for monorepo structure
          if [ -d ".next/standalone/apps/web" ]; then
            echo ""
            echo "Monorepo structure detected!"
            echo "Contents of .next/standalone/apps/web/:"
            ls -la .next/standalone/apps/web/
            
            echo ""
            echo "=========================================="
            echo "Step 2: Copying files (monorepo mode)"
            echo "=========================================="
            
            # Copy web app (contains server.js)
            cp -r .next/standalone/apps/web/* ../../deploy/
            
            # Copy node_modules from standalone root
            if [ -d ".next/standalone/node_modules" ]; then
              cp -r .next/standalone/node_modules ../../deploy/
            fi
            
            # Copy packages if exists (for workspace dependencies)
            if [ -d ".next/standalone/packages" ]; then
              cp -r .next/standalone/packages ../../deploy/
            fi
          else
            echo ""
            echo "Standard structure detected!"
            echo ""
            echo "=========================================="
            echo "Step 2: Copying files (standard mode)"
            echo "=========================================="
            
            cp -r .next/standalone/* ../../deploy/
          fi
          
          echo ""
          echo "=========================================="
          echo "Step 3: Copying static assets"
          echo "=========================================="
          
          # Copy static files (required for Next.js)
          mkdir -p ../../deploy/.next
          cp -r .next/static ../../deploy/.next/
          echo "Copied .next/static"
          
          # Copy public folder
          if [ -d "public" ]; then
            cp -r public ../../deploy/
            echo "Copied public folder"
          fi
          
          echo ""
          echo "=========================================="
          echo "Step 4: Setting up Prisma"
          echo "=========================================="
          
          # Copy Prisma schema
          mkdir -p ../../deploy/prisma
          cp -r ../../packages/database/prisma/* ../../deploy/prisma/
          echo "Copied Prisma schema"
          
          # Copy Prisma client
          mkdir -p ../../deploy/node_modules/.prisma
          mkdir -p ../../deploy/node_modules/@prisma
          cp -r node_modules/.prisma/client ../../deploy/node_modules/.prisma/ 2>/dev/null || echo "No .prisma/client found"
          cp -r node_modules/@prisma/client ../../deploy/node_modules/@prisma/ 2>/dev/null || echo "No @prisma/client found"
          
          echo ""
          echo "=========================================="
          echo "Step 5: Verifying deployment package"
          echo "=========================================="
          
          cd ../../deploy
          
          echo "Final deploy structure:"
          ls -la
          
          # Verify server.js exists
          if [ ! -f "server.js" ]; then
            echo "ERROR: server.js not found in deploy folder!"
            echo "Looking for server.js recursively:"
            find . -name "server.js" -type f
            exit 1
          fi
          
          echo ""
          echo "server.js found!"
          
          echo ""
          echo "=========================================="
          echo "Step 6: Creating ZIP package"
          echo "=========================================="
          
          zip -r ../webapp.zip . -x "*.git*"
          echo "Created webapp.zip"
          ls -la ../webapp.zip

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: webapp.zip

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: build-and-deploy
    steps:
      - name: Wait for deployment
        run: sleep 90

      - name: Check website
        run: |
          WEBAPP_URL="agentdemo-ccfzcrb0a3crh5by.southeastasia-01.azurewebsites.net"
          
          echo "Checking: https://$WEBAPP_URL"
          
          for i in {1..10}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "https://$WEBAPP_URL" || echo "000")
            echo "Attempt $i: HTTP $response"
            
            if [ "$response" -ge 200 ] && [ "$response" -lt 400 ]; then
              echo ""
              echo "========================================"
              echo "Deployment successful!"
              echo "URL: https://$WEBAPP_URL"
              echo "========================================"
              exit 0
            fi
            
            sleep 20
          done
          
          echo ""
          echo "Website health check failed after 10 attempts"
          echo "Please check Azure logs for more details"
          exit 1
