# ============================================
# DAFC OTB Platform - Azure App Service Deployment
# ============================================
#
# Deploy both Next.js frontend and NestJS backend to a single
# Azure App Service using PM2 process manager.
#
# Architecture:
#   - Frontend (Next.js): Port 3000 - uses standalone output
#   - Backend (NestJS): Port 3001 - compiled TypeScript
#   - PM2 manages both processes
#   - Azure routes traffic to port 8080 -> PM2 -> apps
#
# Required GitHub Secrets:
#   - AZURE_WEBAPP_PUBLISH_PROFILE: Download from Azure Portal
#   - DATABASE_URL: PostgreSQL connection string
#   - AUTH_SECRET: NextAuth secret
#   - JWT_SECRET: JWT secret for NestJS
#
# Azure Configuration Required:
#   - SCM_DO_BUILD_DURING_DEPLOYMENT: false
#   - Startup Command: pm2-runtime start ecosystem.config.js
# ============================================

name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: agentdemo
  NODE_VERSION: '20'
  PNPM_VERSION: '9.15.0'

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter=@dafc/database db:generate

      - name: Build NestJS API
        run: pnpm --filter=@dafc/api build

      - name: Build Next.js app
        run: pnpm --filter=@dafc/web build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          NEXT_PUBLIC_API_URL: http://localhost:3001

      - name: Prepare deployment package
        run: |
          set -e
          
          echo "=========================================="
          echo "Creating deployment structure"
          echo "=========================================="
          
          # Create deploy directories
          mkdir -p deploy/web deploy/api
          
          # ========================================
          # Package Next.js (standalone mode)
          # ========================================
          echo "Packaging Next.js..."
          cd apps/web
          
          # Check standalone structure (monorepo creates apps/web inside standalone)
          if [ -d ".next/standalone/apps/web" ]; then
            echo "Monorepo standalone structure detected"
            cp -r .next/standalone/apps/web/* ../../deploy/web/
            cp -r .next/standalone/node_modules ../../deploy/web/ 2>/dev/null || true
            # Copy packages if exists
            if [ -d ".next/standalone/packages" ]; then
              mkdir -p ../../deploy/web/packages
              cp -r .next/standalone/packages/* ../../deploy/web/packages/
            fi
            # In monorepo, .next might exist in standalone output
            if [ -d ".next/standalone/apps/web/.next" ]; then
              echo "Found .next in standalone output"
              cp -r .next/standalone/apps/web/.next ../../deploy/web/
            fi
          else
            echo "Standard standalone structure"
            cp -r .next/standalone/* ../../deploy/web/
          fi
          
          # Merge additional .next files from build (static, server, manifests)
          # These may not be in standalone output
          echo "Merging .next build artifacts..."
          mkdir -p ../../deploy/web/.next
          cp -r .next/static ../../deploy/web/.next/ 2>/dev/null || echo "No static folder"
          cp -r .next/server ../../deploy/web/.next/ 2>/dev/null || echo "No server folder"
          
          # Copy individual manifest files
          for file in BUILD_ID build-manifest.json prerender-manifest.json routes-manifest.json react-loadable-manifest.json package.json app-build-manifest.json; do
            if [ -f ".next/$file" ]; then
              cp ".next/$file" "../../deploy/web/.next/"
              echo "Copied .next/$file"
            fi
          done
          
          # Copy public
          cp -r public ../../deploy/web/
          
          # Debug: show what's in deploy/web/.next
          echo "Contents of deploy/web/.next:"
          ls -la ../../deploy/web/.next/ | head -20
          
          cd ../..
          echo "Next.js packaged successfully"
          
          # ========================================
          # Package NestJS API
          # ========================================
          echo "Packaging NestJS..."
          cp -r apps/api/dist deploy/api/
          cp apps/api/package.json deploy/api/
          
          # Copy Prisma for API
          mkdir -p deploy/api/prisma
          cp -r packages/database/prisma/* deploy/api/prisma/
          
          # Copy node_modules for API (production only)
          mkdir -p deploy/api/node_modules
          cp -r apps/api/node_modules/@nestjs deploy/api/node_modules/ 2>/dev/null || true
          cp -r apps/api/node_modules/@prisma deploy/api/node_modules/ 2>/dev/null || true
          cp -r apps/api/node_modules/.prisma deploy/api/node_modules/ 2>/dev/null || true
          cp -r node_modules/@prisma deploy/api/node_modules/ 2>/dev/null || true
          cp -r node_modules/.prisma deploy/api/node_modules/ 2>/dev/null || true
          
          echo "NestJS packaged successfully"
          
          # ========================================
          # Copy PM2 config and Proxy
          # ========================================
          echo "Setting up PM2 and Proxy..."
          cp ecosystem.config.js deploy/
          cp proxy.js deploy/
          
          # Create package.json for root with http-proxy dependency
          cat > deploy/package.json << 'EOF'
          {
            "name": "dafc-otb-platform",
            "version": "1.0.0",
            "private": true,
            "scripts": {
              "start": "pm2-runtime start ecosystem.config.js"
            },
            "dependencies": {
              "pm2": "^5.3.0",
              "http-proxy": "^1.18.1"
            }
          }
          EOF
          
          # ========================================
          # Final structure check
          # ========================================
          echo ""
          echo "=========================================="
          echo "Final deployment structure:"
          echo "=========================================="
          echo "Root:"
          ls -la deploy/
          echo ""
          echo "Web folder:"
          ls -la deploy/web/ | head -20
          echo ""
          echo "API folder:"
          ls -la deploy/api/ | head -20
          
          # Verify critical files
          if [ ! -f "deploy/web/server.js" ]; then
            echo "ERROR: web/server.js not found!"
            find deploy/web -name "server.js" -type f
            exit 1
          fi
          
          if [ ! -f "deploy/api/dist/main.js" ]; then
            echo "ERROR: api/dist/main.js not found!"
            ls -la deploy/api/dist/ 2>/dev/null || echo "No dist folder"
            exit 1
          fi
          
          if [ ! -f "deploy/proxy.js" ]; then
            echo "ERROR: proxy.js not found!"
            exit 1
          fi
          
          echo ""
          echo "All critical files verified!"
          
          # ========================================
          # Create ZIP
          # ========================================
          echo ""
          echo "Creating ZIP package..."
          cd deploy
          zip -r ../webapp.zip . -x "*.git*"
          cd ..
          
          echo "ZIP created successfully"
          ls -la webapp.zip

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: webapp.zip

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: build-and-deploy
    steps:
      - name: Wait for deployment
        run: sleep 120

      - name: Check services
        run: |
          WEBAPP_URL="agentdemo-ccfzcrb0a3crh5by.southeastasia-01.azurewebsites.net"
          
          echo "Checking frontend..."
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "https://$WEBAPP_URL" || echo "000")
            echo "Frontend attempt $i: HTTP $response"
            if [ "$response" -ge 200 ] && [ "$response" -lt 400 ]; then
              echo "Frontend is accessible!"
              break
            fi
            sleep 20
          done
          
          echo ""
          echo "Checking API..."
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "https://$WEBAPP_URL/api/v1/health/ping" || echo "000")
            echo "API attempt $i: HTTP $response"
            if [ "$response" -ge 200 ] && [ "$response" -lt 400 ]; then
              echo "API is accessible!"
              break
            fi
            sleep 20
          done
          
          echo ""
          echo "========================================"
          echo "Deployment completed!"
          echo "Frontend: https://$WEBAPP_URL"
          echo "API: https://$WEBAPP_URL/api/v1"
          echo "========================================"
